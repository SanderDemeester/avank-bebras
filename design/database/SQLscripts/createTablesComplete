CREATE TABLE helpTeachers(
teacherID text NOT NULL REFERENCES Users,
classID text NOT NULL REFERENCES Classes,
PRIMARY KEY (teacherID,classID)
);

CREATE TABLE anonAnswer(
id SERIAL,
questionID text NOT NULL REFERENCES Questions,
contestID text NOT NULL REFERENCES Contests,
answer text NOT NULL,
PRIMARY KEY (id)
);

ALTER TABLE Users ADD COLUMN comment text;

ALTER TABLE Questions ADD COLUMN author text;
ALTER TABLE Users DROP CONSTRAINT users_check;
ALTER TABLE Users ADD COLUMN class text REFERENCES Classes;
ALTER TABLE Users ALTER COLUMN Type SET NOT NULL;
ALTER TABLE Users ALTER COLUMN Type TYPE text;

ALTER TABLE Questions ADD CONSTRAINT forkey FOREIGN KEY (author) REFERENCES users;
ALTER TABLE Questions DROP COLUMN namedut;
ALTER TABLE Questions DROP COLUMN namefr;
ALTER TABLE Questions DROP COLUMN namege;
ALTER TABLE Questions DROP COLUMN correctansdut;
ALTER TABLE Questions DROP COLUMN correctansfr;
ALTER TABLE Questions DROP COLUMN correctansge;
ALTER TABLE Questions DROP COLUMN type;

ALTER TABLE QuestionSets ADD COLUMN active bool NOT NULL;
ALTER TABLE QuestionSets ADD COLUMN name text NOT NULL;

ALTER TABLE AnonAnswer DROP COLUMN contestid;
ALTER TABLE AnonAnswer ADD COLUMN questionsetid text NOT NULL;
ALTER TABLE AnonAnswer ADD FOREIGN KEY (questionsetid) REFERENCES questionsets;
ALTER TABLE AnonAnswer ADD COLUMN correct bool NOT NULL;
ALTER TABLE AnonAnswer ADD COLUMN language text NOT NULL;

ALTER TABLE PupilAnswers DROP COLUMN contid;
ALTER TABLE PupilAnswers ADD COLUMN questionsetid text NOT NULL;
ALTER TABLE PupilAnswers ADD FOREIGN KEY (questionsetid) REFERENCES questionsets;
ALTER TABLE PupilAnswers ADD COLUMN correct bool NOT NULL;
ALTER TABLE PupilAnswers ADD COLUMN language text NOT NULL;

CREATE TABLE faq(
id SERIAL,
name text,
content text,
language text NOT NULL,
PRIMARY KEY (id)
);
ALTER TABLE contests ALTER COLUMN type TYPE text;

ALTER TABLE servers ADD COLUMN ftpUri text;
ALTER TABLE servers ALTER COLUMN ftpUri SET NOT NULL;

ALTER TABLE servers ADD COLUMN ftpPort text;
ALTER TABLE servers ALTER COLUMN ftpPort SET NOT NULL;

ALTER TABLE servers ADD COLUMN ftpUser text;
ALTER TABLE servers ALTER COLUMN ftpUser SET NOT NULL;

ALTER TABLE servers ADD COLUMN ftpPass text;
ALTER TABLE servers ALTER COLUMN ftpPass SET NOT NULL;

DROP TABLE questionsetquestions;
DROP TABLE anonanswer;
DROP TABLE pupilanswers;
DROP TABLE questions;

CREATE TABLE questions(
id SERIAL,
officialid text,
serverID text NOT NULL REFERENCES servers,
path text NOT NULL,
active boolean NOT NULL,
author text REFERENCES users,
PRIMARY KEY (id)
);

CREATE TABLE questionsetquestions(
qid integer REFERENCES questions,
qsid text REFERENCES questionsets,
difficulty text NOT NULL,
PRIMARY KEY (qid,qsid)
);

CREATE TABLE anonanswer(
id SERIAL,
questionid integer NOT NULL REFERENCES questions,
answer text NOT NULL,
correct boolean NOT NULL,
language text NOT NULL,
questionsetid text NOT NULL REFERENCES questionsets,
PRIMARY KEY (id)
);

CREATE TABLE pupilanswers(
indid text REFERENCES users,
qid integer REFERENCES questions,
questionsetid text REFERENCES questionsets,
answer text NOT NULL,
correct boolean NOT NULL,
language text NOT NULL,
PRIMARY KEY (indid,qid,questionsetid)
);
ALTER TABLE contests DROP CONSTRAINT contests_type_check;
ALTER TABLE schools ADD COLUMN orig text REFERENCES users;
-- create new tables

CREATE TABLE grades(
name text,
startage integer NOT NULL,
endage integer NOT NULL,
PRIMARY KEY (name)
);

CREATE TABLE difficulties(
name text,
ordr integer NOT NULL,
PRIMARY KEY (name)
);

CREATE TABLE links(
title text,
url text NOT NULL,
PRIMARY KEY (title)
);

-- Change references to classes

DROP TABLE classpupil;
DROP TABLE contestclasses;
DROP TABLE helpteachers;
ALTER TABLE users DROP COLUMN class;

DROP TABLE classes;
DROP TABLE schools;

-- remake schools & classes with SERIAL

CREATE TABLE schools(
id SERIAL,
name text NOT NULL,
address text NOT NULL,
orig text REFERENCES users,
PRIMARY KEY (id)
);

CREATE TABLE classes(
id SERIAL,
name text NOT NULL,
expdate date NOT NULL,
schoolid integer NOT NULL REFERENCES schools,
teacherid text NOT NULL REFERENCES users,
level text NOT NULL,
PRIMARY KEY (id)
);

-- recreate deleted tables

ALTER TABLE users ADD COLUMN class integer;
ALTER TABLE users ADD FOREIGN KEY (class) REFERENCES classes;

CREATE TABLE helpteachers(
teacherid text REFERENCES users,
classid integer REFERENCES classes,
PRIMARY KEY (teacherid,classid)
);

CREATE TABLE contestclasses(
classid integer REFERENCES classes,
contestid text REFERENCES contests,
PRIMARY KEY (classid,contestid)
);

CREATE TABLE classpupil(
classid integer REFERENCES classes,
indid text REFERENCES users,
PRIMARY KEY (classid,indid)
);
ALTER TABLE contests ADD COLUMN creator text;
ALTER TABLE contests ADD FOREIGN KEY (creator) REFERENCES users;
ALTER TABLE contests ALTER COLUMN creator SET NOT NULL;
ALTER TABLE servers ADD COLUMN ftppath text;
ALTER TABLE questions DROP COLUMN path;

ALTER TABLE grades RENAME COLUMN startage TO lowerbound;
ALTER TABLE grades RENAME COLUMN endage TO upperbound;

ALTER TABLE difficulties RENAME COLUMN ordr TO rank;
ALTER TABLE difficulties ADD CONSTRAINT diff_uniq_rank UNIQUE (rank);
ALTER TABLE servers ADD COLUMN is_http_secured boolean;
ALTER TABLE servers ADD COLUMN http_username text;
ALTER TABLE servers ADD COLUMN http_password text;

ALTER TABLE classes ADD FOREIGN KEY (level) REFERENCES grades;

ALTER TABLE users ADD COLUMN reset_token text;
ALTER TABLE servers ALTER COLUMN is_http_secured SET NOT NULL;

ALTER TABLE contests ADD COLUMN duration integer;
ALTER TABLE contests ALTER COLUMN duration SET NOT NULL;

DROP TABLE anonanswer;
DROP TABLE pupilanswers;
DROP TABLE questionsetquestions;
DROP TABLE questionsets;

CREATE TABLE questionsets(
id SERIAL,
level text NOT NULL,
contid text NOT NULL REFERENCES contests,
active boolean NOT NULL,
name text NOT NULL,
PRIMARY KEY (id)
);

CREATE TABLE questionsetquestions(
qid integer NOT NULL REFERENCES questions,
qsid integer NOT NULL REFERENCES questionsets,
difficulty text NOT NULL,
PRIMARY KEY (qid,qsid)
);

CREATE TABLE anonanswer(
id SERIAL,
questionid integer NOT NULL REFERENCES questions,
answer text NOT NULL,
correct boolean NOT NULL,
language text NOT NULL,
questionsetid integer NOT NULL REFERENCES questionsets,
PRIMARY KEY (id)
);

CREATE TABLE pupilanswers(
indid text NOT NULL REFERENCES users,
qid integer NOT NULL REFERENCES questions,
questionsetid integer NOT NULL REFERENCES questionsets,
answer text NOT NULL,
correct boolean NOT NULL,
language text NOT NULL,
PRIMARY KEY (indid,qid,questionsetid)
);
ALTER TABLE questionsets ADD CONSTRAINT qs_lvl_forkey FOREIGN KEY (level) REFERENCES grades;
ALTER TABLE questionsetquestions ADD CONSTRAINT qsq_diff_forkey FOREIGN KEY (difficulty) REFERENCES difficulties;
ALTER TABLE difficulties ADD COLUMN cpoints int NOT NULL;
ALTER TABLE difficulties ADD COLUMN wpoints int NOT NULL;
ALTER TABLE difficulties ADD COLUMN npoints int NOT NULL;

CREATE TABLE competitionScore(
qsID integer REFERENCES questionSets,
uID text REFERENCES users,
score integer NOT NULL,
PRIMARY KEY (qsID, uID)
);

ALTER TABLE users ADD CONSTRAINT unique_email UNIQUE (email);
ALTER TABLE users DROP COLUMN active;
ALTER TABLE users ADD COLUMN blockedUntil date;
